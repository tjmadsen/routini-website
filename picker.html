<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Select Spreadsheet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error {
            text-align: center;
            color: #d93025;
            padding: 20px;
        }
        .error h2 {
            margin-bottom: 8px;
        }
        .retry-button {
            margin-top: 16px;
            padding: 12px 24px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .retry-button:hover {
            background-color: #3367d6;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading file picker...</p>
    </div>
    <div id="error" class="error" style="display: none;">
        <h2>Unable to load picker</h2>
        <p id="error-message"></p>
        <button class="retry-button" onclick="location.reload()">Try Again</button>
    </div>

    <script>
        // Configuration from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const config = {
            apiKey: urlParams.get('apiKey'),
            appId: urlParams.get('appId'),
            oauthToken: urlParams.get('token')
        };

        // Validate config
        if (!config.apiKey || !config.appId || !config.oauthToken) {
            showError('Missing configuration. Please try again.');
        } else {
            loadPickerApi();
        }

        // Load the Google Picker API
        function loadPickerApi() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = onApiLoad;
            script.onerror = () => showError('Failed to load Google API');
            document.head.appendChild(script);
        }

        function onApiLoad() {
            gapi.load('picker', { callback: createPicker, onerror: () => showError('Failed to load Picker API') });
        }

        function createPicker() {
            if (!config.oauthToken) {
                showError('No authentication token provided');
                return;
            }

            try {
                // Create a view that shows only Google Sheets
                const view = new google.picker.DocsView(google.picker.ViewId.SPREADSHEETS)
                    .setIncludeFolders(true)
                    .setSelectFolderEnabled(false);

                const picker = new google.picker.PickerBuilder()
                    .setDeveloperKey(config.apiKey)
                    .setAppId(config.appId)
                    .setOAuthToken(config.oauthToken)
                    .addView(view)
                    .setOrigin(window.location.protocol + '//' + window.location.host)
                    .setTitle('Select your Routini spreadsheet')
                    .setCallback(pickerCallback)
                    .build();

                // Hide loading and show picker
                document.getElementById('loading').style.display = 'none';
                picker.setVisible(true);
            } catch (e) {
                showError('Failed to create picker: ' + e.message);
            }
        }

        function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                // Redirect to app using custom URL scheme
                const encodedName = encodeURIComponent(doc.name);
                window.location.href = 'routini://picker-result?id=' + doc.id + '&name=' + encodedName;
            } else if (data.action === google.picker.Action.CANCEL) {
                // Redirect to app with cancelled flag
                window.location.href = 'routini://picker-result?cancelled=true';
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
            // Also notify iOS of the error
            if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.pickerResult) {
                window.webkit.messageHandlers.pickerResult.postMessage(JSON.stringify({ error: message }));
            }
        }
    </script>
</body>
</html>
